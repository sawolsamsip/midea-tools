version: "3.9"

services:

  # ------------------------------------------------
  # 1. Nginx Proxy Manager (게이트웨이) - 통합
  # ------------------------------------------------
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    ports:
      # 호스트 포트 80, 443은 NPM이 독점적으로 사용합니다.
      - "80:80"
      - "81:81"
      - "443:443"
    environment:
      - TZ=America/Los_Angeles
    volumes:
      # NPM 설정 파일 경로 변경
      - /mnt/cache/appdata/npm/data:/data
      - /mnt/cache/appdata/npm/letsencrypt:/etc/letsencrypt
    restart: unless-stopped
    networks:
      - media-net # 통합 네트워크 사용

  # ------------------------------------------------
  # 2. Nginx 웹 서버 (4개 웹사이트 서빙) - 통합 및 포트 제거
  # ------------------------------------------------
  nginx-website:
    image: nginx:alpine
    container_name: nginx-website
    restart: always
    volumes:
      # Nginx 설정 파일 경로 변경
      - /mnt/cache/appdata/web-tools/nginx-conf/default.conf:/etc/nginx/conf.d/default.conf:ro
      # 4개 웹사이트 데이터 폴더 경로 변경
      - /mnt/cache/webdata/mongoori.com:/usr/share/nginx/html/mongoori.com:ro
      - /mnt/cache/webdata/seouloved.com:/usr/share/nginx/html/seouloved.com:ro
      - /mnt/cache/webdata/primepicksusa.com:/usr/share/nginx/html/primepicksusa.com:ro
      - /mnt/cache/webdata/mijutalk.co:/usr/share/nginx/html/mijutalk.co:ro
    networks:
      - media-net # 통합 네트워크 사용

  # ------------------------------------------------
  # 3. Plex (포트 추가됨)
  # ------------------------------------------------
  plex:
    image: linuxserver/plex:latest
    container_name: plex
    ports:
      - "32400:32400" # 호스트 포트 32400으로 노출 (Web UI 접속용)
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - VERSION=latest
      - PLEX_CLAIM=claim-ZBu3faKSWHiLarWz_HE9
    volumes:
      - /mnt/cache/appdata/plex:/config
      - /mnt/zurg:/mnt/zurg
    restart: unless-stopped
    networks:
      - media-net # 네트워크 명시

  # ------------------------------------------------
  # 4. Emby Media Server (추가됨)
  # ------------------------------------------------
  emby:
    image: linuxserver/emby:latest
    container_name: emby
    ports:
      - "8096:8096" # Emby Web UI 및 API 포트
      - "8920:8920" # HTTPS 포트
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/emby:/config
      - /mnt/zurg:/data/media # 미디어 파일 접근을 위해 동일하게 마운트
    restart: unless-stopped
    networks:
      - media-net
      
  # ------------------------------------------------
  # 5. Sonarr (TV Shows)
  # ------------------------------------------------
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/sonarr:/config
      - /mnt/zurg:/mnt/zurg
    ports:
      - "8989:8989"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 6. Radarr (Movies)
  # ------------------------------------------------
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/radarr:/config
      - /mnt/zurg:/mnt/zurg
    ports:
      - "7878:7878"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 7. Bazarr (volumes 수정됨)
  # ------------------------------------------------
  bazarr:
    image: linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/bazarr:/config
      - /mnt/zurg:/mnt/zurg # <--- 컨테이너 경로 추가됨
    ports:
      - "6767:6767"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 8. Jackett
  # ------------------------------------------------
  jackett:
    image: linuxserver/jackett:latest
    container_name: jackett
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
    volumes:
      - /mnt/cache/appdata/jackett:/config
    ports:
      - "9117:9117"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 9. Prowlarr
  # ------------------------------------------------
  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/prowlarr:/config
    ports:
      - "9696:9696"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 10. Flaresolverr
  # ------------------------------------------------
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - TZ=America/Los_Angeles
    ports:
      - "8191:8191"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 11. Overseerr to Jellyseerr to Seerr
  # ------------------------------------------------
  seerr:
    image: seerr/seerr:develop
    init: true
    container_name: seerr
    environment:
      - PUID=1000
      - PGID=1000
      - LOG_LEVEL=debug
      - TZ=America/Los_Angeles
      - PORT=5055
    ports:
      - 5055:5055
    volumes:
      - /mnt/cache/appdata/seerr:/app/config
      - /mnt/zurg:/mnt/zurg # <--- 컨테이너 경로 추가됨
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 3
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 12. CLI_Debrid (API 전송 담당)
  # ------------------------------------------------

  cli_debrid: 
    image: godver3/cli_debrid:dev
    pull_policy: always
    container_name: cli_debrid
    ports:
      - "5000:5000"
      - "5001:5001"
      - "8888:8888"
    volumes:
      # DB content
      - /mnt/cache/appdata/cli_debrid/db_content:/user/db_content
      # Config (API key, tokens, settings)
      - /mnt/cache/appdata/cli_debrid/config:/user/config
      # Logs
      - /mnt/cache/appdata/cli_debrid/logs:/user/logs
      # Mount entire /mnt so CLI_Debrid can read all media
      - /mnt:/mnt
      # Hyperswarm Phalanx DB (VERY IMPORTANT)
      - /mnt/cache/appdata/cli_debrid/phalanx_db_hyperswarm/autobase_storage_v4:/app/phalanx_db_hyperswarm/autobase_storage_v4
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - LOG_LEVEL=DEBUG
    restart: unless-stopped
    tty: true
    stdin_open: true
    networks:
      - media-net

  # ------------------------------------------------
  # 13. zurg & rclone 
  # ------------------------------------------------
  zurg:
    image: ghcr.io/debridmediamanager/zurg:latest
    container_name: zurg
    restart: unless-stopped
    ports:
      - 9999:9999
    volumes:
      - /mnt/cache/appdata/zurg/config.yml:/app/config.yml
      - /mnt/cache/appdata/zurg/logs:/app/logs
      - /mnt/cache/appdata/zurg/data:/app/data
      - /mnt/cache/appdata/zurg/dump:/app/dump
      - /mnt/cache/appdata/zurg/strm:/app/strm
      - /mnt/cache/appdata/zurg/plex_update.sh:/app/plex_update.sh
      - /mnt/cache/appdata/zurg/emby_update.sh:/app/emby_update.sh
    networks: 
      - media-net
    
  rclone:
    image: rclone/rclone:latest
    container_name: rclone
    restart: unless-stopped
    environment:
      TZ: America/Los_Angeles
      PUID: 1000
      PGID: 1000
    volumes:
      - /mnt/zurg:/data:rshared
      - /mnt/cache/appdata/zurg/rclone.conf:/config/rclone/rclone.conf
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/fuse
    command: "mount zurg: /data --allow-non-empty --allow-other --vfs-read-chunk-size 1M --uid 1000 --gid 1000"
    networks: 
      - media-net


networks:
  media-net:
    driver: bridge
