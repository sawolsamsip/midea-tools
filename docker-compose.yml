version: "3.9"

services:

  # ------------------------------------------------
  # 1. Nginx Proxy Manager (게이트웨이) - 통합
  # ------------------------------------------------
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    ports:
      # 호스트 포트 80, 443은 NPM이 독점적으로 사용합니다.
      - "80:80"
      - "81:81"
      - "443:443"
    environment:
      - TZ=America/Los_Angeles
    volumes:
      # NPM 설정 파일 경로 변경
      - /mnt/cache/appdata/npm/data:/data
      - /mnt/cache/appdata/npm/letsencrypt:/etc/letsencrypt
    restart: unless-stopped
    networks:
      - media-net # 통합 네트워크 사용

  # ------------------------------------------------
  # 2. Nginx 웹 서버 (4개 웹사이트 서빙) - 통합 및 포트 제거
  # ------------------------------------------------
  nginx-website:
    image: nginx:alpine
    container_name: nginx-website
    restart: always
    volumes:
      # Nginx 설정 파일 경로 변경
      - /mnt/cache/appdata/web-tools/nginx-conf/default.conf:/etc/nginx/conf.d/default.conf:ro
      # 4개 웹사이트 데이터 폴더 경로 변경
      - /mnt/cache/webdata/mongoori.com:/usr/share/nginx/html/mongoori.com:ro
      - /mnt/cache/webdata/seouloved.com:/usr/share/nginx/html/seouloved.com:ro
      - /mnt/cache/webdata/primepicksusa.com:/usr/share/nginx/html/primepicksusa.com:ro
      - /mnt/cache/webdata/mijutalk.co:/usr/share/nginx/html/mijutalk.co:ro
    # 포트 매핑 제거: NPM이 컨테이너 이름으로 바로 접속합니다.
    networks:
      - media-net # 통합 네트워크 사용
  
  # ------------------------------------------------
  # 3. Plex
  # ------------------------------------------------
  plex:
    image: linuxserver/plex:latest
    container_name: plex
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - VERSION=latest
      - PLEX_CLAIM=claim-ZBu3faKSWHiLarWz_HE9
    volumes:
      - /mnt/cache/appdata/plex:/config
      - /mnt/zurg:/mnt/zurg
    restart: unless-stopped
  # ------------------------------------------------
  # 4. Sonarr (TV Shows)
  # ------------------------------------------------
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/sonarr:/config
      - /mnt/zurg:/mnt/zurg
    ports:
      - "8989:8989"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 5. Radarr (Movies)
  # ------------------------------------------------
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/radarr:/config
      - /mnt/zurg:/mnt/zurg
    ports:
      - "7878:7878"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 6. Bazarr
  # ------------------------------------------------
  bazarr:
    image: linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/bazarr:/config
      - /mnt/zurg
    ports:
      - "6767:6767"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 7. Jackett
  # ------------------------------------------------
  jackett:
    image: linuxserver/jackett:latest
    container_name: jackett
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
    volumes:
      - /mnt/cache/appdata/jackett:/config
    ports:
      - "9117:9117"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 8. Prowlarr
  # ------------------------------------------------
  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - UMASK_SET=002
    volumes:
      - /mnt/cache/appdata/prowlarr:/config
    ports:
      - "9696:9696"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 9. Flaresolverr
  # ------------------------------------------------
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - TZ=America/Los_Angeles
    ports:
      - "8191:8191"
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 10. Overseerr to Jellyseerr to Seerr
  # ------------------------------------------------
  seerr:
    image: seerr/seerr:develop
    init: true
    container_name: seerr
    environment:
      - PUID=1000
      - PGID=1000
      - LOG_LEVEL=debug
      - TZ=America/Los_Angeles
      - PORT=5055
    ports:
      - 5055:5055
    volumes:
      - /mnt/cache/appdata/seerr:/app/config
      - /mnt/zurg
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 3
    restart: unless-stopped
    networks:
      - media-net
  # ------------------------------------------------
  # 11. CLI_Debrid (API 전송 담당)
  # ------------------------------------------------

  cli_debrid: 
    image: godver3/cli_debrid:dev
    pull_policy: always
    container_name: cli_debrid
    ports:
      - "5000:5000"
      - "5001:5001"
      - "8888:8888"
    volumes:
      # DB content
      - /mnt/cache/appdata/cli_debrid/db_content:/user/db_content
      # Config (API key, tokens, settings)
      - /mnt/cache/appdata/cli_debrid/config:/user/config
      # Logs
      - /mnt/cache/appdata/cli_debrid/logs:/user/logs
      # Mount entire /mnt so CLI_Debrid can read all media
      - /mnt:/mnt
      # Hyperswarm Phalanx DB (VERY IMPORTANT)
      - /mnt/cache/appdata/cli_debrid/phalanx_db_hyperswarm/autobase_storage_v4:/app/phalanx_db_hyperswarm/autobase_storage_v4
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Los_Angeles
      - LOG_LEVEL=DEBUG
    restart: unless-stopped
    tty: true
    stdin_open: true
    networks:
      - media-net

networks:
  media-net:
    driver: bridge
